name: Tests

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install --frozen-lockfile

      - name: Run Tests
        run: bun run test

      - name: Get Vercel Preview URL
        uses: zentered/vercel-preview-url@v1.1.9
        id: vercel_preview_url
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        with:
          vercel_project_id: ${{ secrets.VERCEL_PROJECT_ID }}
        # Only run on pull requests
        if: github.event_name == 'pull_request'

      - name: Test CLI Examples with Preview URL (PR)
        if: github.event_name == 'pull_request'
        run: |
          # Build the CLI first
          bun run build:cli

          # Change to CLI directory
          cd packages/cli

          # Get the preview URL from the previous step
          PREVIEW_URL="${{ steps.vercel_preview_url.outputs.preview_url }}"

          echo "Testing against Vercel preview: $PREVIEW_URL"

          # Create temporary copies of examples with preview URLs
          mkdir -p examples-ci
          for file in examples/*.yaml; do
            sed "s|http://localhost:3000|$PREVIEW_URL|g" "$file" > "examples-ci/$(basename $file)"
          done

          # Run all example YAML files with preview endpoints
          ./curl-runner examples-ci/

          # Clean up
          rm -rf examples-ci

      - name: Test CLI Examples with Production URL (Main)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # Build the CLI first
          bun run build:cli

          # Change to CLI directory
          cd packages/cli

          echo "Testing against production: https://curl-runner.com"

          # Create temporary copies of examples with production URLs
          mkdir -p examples-ci
          for file in examples/*.yaml; do
            sed "s|http://localhost:3000|https://curl-runner.com|g" "$file" > "examples-ci/$(basename $file)"
          done

          # Run all example YAML files with production endpoints
          ./curl-runner examples-ci/

          # Clean up
          rm -rf examples-ci
